---
title: "Final Report"
subtitle: "Experiments and Causality"
author: "Colby Carter, Abhishek Agarwal, Tiffany Jaya"
date: \today
output: pdf_document
---

## Load the libraries

```{r, message=FALSE}
library(data.table) # fread
library(dplyr)
library(geonames)
library(lmtest) # coeftest
library(lubridate) # time conversion
library(sandwich) # vcovHC
library(RJSONIO)
```

## Helper functions

```{r}
convert_fctr_to_boolean <- function(col) {
  return(as.numeric(as.logical(col)))
}

convert_fctr_to_datetime <- function(col) {
  return(as.POSIXct(col, format="%Y-%m-%d %H:%M:%S"))
}

convert_fctr_to_numeric <- function(col) {
  return(as.numeric(levels(col)[col]))
}

convert_fctr_to_str <- function(col) {
  return(as.character(col))
}
```

## Load the dataset

```{r}
# pilot study
d <- read.csv(file = "./W241 Colby Carter, Tiffany Jaya, Abhishek Agarwal_April 5, 2018_00.27.csv",
              header = TRUE, 
              sep = ",")
```

```{r}
# actual study
d <- read.csv(file = "./W241 Colby Carter, Tiffany Jaya, Abhishek Agarwal_April 12, 2018_09.41.csv",
              header = TRUE, 
              sep = ",")
```

## Clean up the dataset

**WARNING: DO NOT RERUN THIS SECTION TWICE!**

```{r}
# rename columns to be more descriptive
setnames(d, 
         old = c("Q1.1", 
                 "Q2.2_1",
                 "Q2.3_1",
                 "Q2.5_1",
                 "Q2.7_1",
                 "Q3.1_1", 
                 "Q3.3_1",
                 "Q3.5_1",
                 "Q3.7_1",
                 "Q4.1",
                 "Q4.2",
                 "Q4.3",
                 "Q4.4",
                 "Q4.5",
                 "Q4.6",
                 "Q4.7",
                 "Q4.8",
                 "Q4.9",
                 "Q4.10",
                 "Q4.11",
                 "Q4.12",
                 "Q4.13",
                 "Q4.14",
                 "Q4.15",
                 "Q4.16", 
                 "Q2.1_First.Click",
                 "Q2.1_Last.Click",
                 "Q2.1_Page.Submit",
                 "Q2.1_Click.Count",
                 "Q2.4_First.Click",
                 "Q2.4_Last.Click",
                 "Q2.4_Page.Submit",
                 "Q2.4_Click.Count",
                 "Q2.6_First.Click",
                 "Q2.6_Last.Click",
                 "Q2.6_Page.Submit",
                 "Q2.6_Click.Count",
                 "Q2.8_First.Click",
                 "Q2.8_Last.Click",
                 "Q2.8_Page.Submit",
                 "Q2.8_Click.Count",
                 "Q3.2_First.Click",
                 "Q3.2_Last.Click",
                 "Q3.2_Page.Submit",
                 "Q3.2_Click.Count",
                 "Q3.4_First.Click",
                 "Q3.4_Last.Click",
                 "Q3.4_Page.Submit",
                 "Q3.4_Click.Count",
                 "Q3.6_First.Click",
                 "Q3.6_Last.Click",
                 "Q3.6_Page.Submit",
                 "Q3.6_Click.Count",
                 "Q3.8_First.Click",
                 "Q3.8_Last.Click",
                 "Q3.8_Page.Submit",
                 "Q3.8_Click.Count"),
         new = c("consent", 
                 "control_employment",
                 "control_education", # baseline
                 "control_retirement",
                 "control_cybersecurity",
                 "treatment_employment",
                 "treatment_education", # baseline,
                 "treatment_retirement",
                 "treatment_cybersecurity",
                 "gender",
                 "age",
                 "highest_education",
                 "employment_status",
                 "marital_status",
                 "zip_code",
                 "community", # rural, urban, suburban
                 "can_vote",
                 "political_party",
                 "ethnicity",
                 "income",
                 "have_kids",
                 "internet_from_mobile",
                 "internet_from_home",
                 "internet_from_work",
                 "who_pays_internet",
                 "control_employment_First.Click",
                 "control_employment_Last.Click",
                 "control_employment_Page.Submit",
                 "control_employment_Click.Count",
                 "control_education_First.Click",
                 "control_education_Last.Click",
                 "control_education_Page.Submit",
                 "control_education_Click.Count",
                 "control_retirement_First.Click",
                 "control_retirement_Last.Click",
                 "control_retirement_Page.Submit",
                 "control_retirement_Click.Count",
                 "control_cybersecurity_First.Click",
                 "control_cybersecurity_Last.Click",
                 "control_cybersecurity_Page.Submit",
                 "control_cybersecurity_Click.Count",
                 "treatment_employment_First.Click",
                 "treatment_employment_Last.Click",
                 "treatment_employment_Page.Submit",
                 "treatment_employment_Click.Count",
                 "treatment_education_First.Click",
                 "treatment_education_Last.Click",
                 "treatment_education_Page.Submit",
                 "treatment_education_Click.Count",
                 "treatment_retirement_First.Click",
                 "treatment_retirement_Last.Click",
                 "treatment_retirement_Page.Submit",
                 "treatment_retirement_Click.Count",
                 "treatment_cybersecurity_First.Click",
                 "treatment_cybersecurity_Last.Click",
                 "treatment_cybersecurity_Page.Submit",
                 "treatment_cybersecurity_Click.Count"))
```

```{r}
# 1. remove the first two rows
d <- tail(d, -2)
# 2. remove rownames to avoid confusion (because it is not the subject's id)
rownames(d) <- NULL
# 3. safely convert columns of type factors to their respective types
# 3a. factor -> datetime
cols <- c("StartDate", "EndDate", "RecordedDate")
d[,cols] <- lapply(d[,cols], convert_fctr_to_datetime)
# 3b. factor -> logical/boolean
cols <- c("Finished")
d[,cols] <- lapply(d[,cols], convert_fctr_to_boolean)
d$consent <- ifelse(d$consent == "Yes", 1, 0)
d$can_vote <- ifelse(d$can_vote == "Yes", 1, 0)
d$have_kids <- ifelse(d$have_kids == "Yes", 1, 0)
# 3c. factor -> numeric
cols <- c("Progress", 
          "Duration..in.seconds.", 
          "LocationLatitude", 
          "LocationLongitude",
          "control_employment", 
          "control_education", 
          "control_retirement", 
          "control_cybersecurity",
          "treatment_employment", 
          "treatment_education", 
          "treatment_retirement", 
          "treatment_cybersecurity",
          "zip_code",
          "control_employment_First.Click", 
          "control_employment_Last.Click", 
          "control_employment_Page.Submit", 
          "control_employment_Click.Count", 
          "control_education_First.Click",
          "control_education_Last.Click",
          "control_education_Page.Submit",
          "control_education_Click.Count",
          "control_retirement_First.Click",
          "control_retirement_Last.Click",
          "control_retirement_Page.Submit",
          "control_retirement_Click.Count",
          "control_cybersecurity_First.Click",
          "control_cybersecurity_Last.Click",
          "control_cybersecurity_Page.Submit",
          "control_cybersecurity_Click.Count",
          "treatment_employment_First.Click",
          "treatment_employment_Last.Click",
          "treatment_employment_Page.Submit",
          "treatment_employment_Click.Count",
          "treatment_education_First.Click",
          "treatment_education_Last.Click",
          "treatment_education_Page.Submit",
          "treatment_education_Click.Count",
          "treatment_retirement_First.Click",
          "treatment_retirement_Last.Click",
          "treatment_retirement_Page.Submit",
          "treatment_retirement_Click.Count",
          "treatment_cybersecurity_First.Click",
          "treatment_cybersecurity_Last.Click",
          "treatment_cybersecurity_Page.Submit",
          "treatment_cybersecurity_Click.Count"
          )
d[,cols] <- lapply(d[,cols], convert_fctr_to_numeric)
# 3d. factor -> str
cols <- c("IPAddress", "ResponseId", "UserLanguage", "highest_education")
d[,cols] <- lapply(d[,cols], convert_fctr_to_str)
```

## Add additional information into the dataset

```{r, echo=FALSE}
# login information
options(geonamesUsername="sullivannicole")
```

```{r}
# get country information based on latlong
country_names <- mapply(
  function(lat, long) {
    suppressWarnings(try(GNcountryCode(lat, long)$countryName, silent = TRUE))
  }, d$LocationLatitude, d$LocationLongitude)
d$country <- country_names
```

## List all the columns

```{r}
colnames(d)
```

## Analysis

data: contains the original dataset
```{r}
# save a copy of the original dataset
data <- d
```

### Filter

d: contains the dataset after we filtered out for the following:

1. subjects who did not finish the survey 100%
2. subjects who consented to take the survey

```{r}
# filter for subjects who consented to take the survey
d <- d[which(d$consent == 1),]
```

3. subjects who are from USA

```{r}
# filter for subjects who are from USA
d <- d %>% filter(., country == "United States")
```

4. subjects who took the survey once

```{r}
# filter out subjects who took the survey more than once
subjects.repeater <- d %>% group_by(IPAddress) %>% summarize(freq = sum(n())) %>% filter(freq > 1)
d <- d %>% filter(!(IPAddress %in% subjects.repeater$IPAddress))
```

5. 

### How many took the survey?

```{r}
# how many subjects take the survey?
nrow(data)
```

638 subjects take the survey.

### Verify that ResponseId is unique

```{r}
# is ResponseId unique? 
# if yes, use ResponseId as a unique id
freq_responseid <- data %>% group_by(ResponseId) %>% summarize(freq = sum(n()))
sum(freq_responseid$freq > 1) == 0
```

ResponseId is unique. 

### Verify that all the subjects completed the survey

```{r}
# how many subjects did not finish the survey?
sum(!data$Finished)
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the progress of each subject
hist(data$Progress, 
     xlab = "progress (%)",
     ylab = "number of users",
     breaks = -0.5:100.5, 
     ylim = c(0, 700),
     labels = TRUE)
```

All of the subjects completed the survey. 

### Verify that all subjects completed the survey in reasonable time (greater than 2 minutes)

```{r}
# how long does it take the subjects who consented to finish the survey in minutes?
subjects.consent <- data[which(data$consent == 1),]
summary(subjects.consent$Duration..in.seconds./60)
```

The following checks are unnecessary:

```{r}
# list all the subjects who take less than 2 minutes to finish the survey
subjects.less_2_min <- data[which(data$Duration..in.seconds./60 < 2),]
nrow(subjects.less_2_min)
```

```{r}
# list all subjects who did not consent
subjects.no_consent <- data[which(data$consent == 0),]
nrow(subjects.no_consent)
```

```{r}
# verify that the subjects who did not consent 
# match the subjects who took the survey in less than 2 minutes
all(subjects.less_2_min$ResponseId %in% subjects.no_consent$ResponseId)
```

### Verify that all subjects have English set as their language

```{r}
# list all languages not in English
data[which(data$UserLanguage != "EN"),]$UserLanguage
```

### Verify that all subjects are from United States

```{r}
# how many subjects are from United States?
data %>% filter(., country == "United States") %>% count(.)
# how many subjects are from outside the United States?
data %>% filter(., country != "United States") %>% count(.)
```

Out of 638 subjects, 580 subjects are from the United States and 58 are from outside the United States.

### Verify that subjects only took the survey once

```{r}
subjects.repeater
```

All devices connected to the same router will share the same external IP address.

```{r}
d %>% filter(IPAddress == "170.185.202.19")
```

It might be that the two women who took the survey are roommates, but since we have no way to confirm, it is better not to use this dataset in the study.

```{r}
d %>% filter(IPAddress == "24.46.117.154")
```

It's simply not possible that different people with different zip codes to have the same IP address. The reliability of this data is questionable. It might be possible that friends come over to take the same survey, but since we have no way to confirm, it is better not to use this dataset in the study.

```{r}
d %>% filter(IPAddress == "50.88.107.50")
```

With the same reasoning as above, it is better not to use this dataset.

```{r}
d %>% filter(IPAddress == "67.183.210.112")
```

With the same reasoning as above, it is better not to use this dataset.

### Verify that subjects answer all the questions

```{r}
# check if subjects in control answer all questions
d %>%
  select(control_employment, control_education, control_retirement, control_cybersecurity) %>%
  summarise_all(funs(sum(!is.na(.))))
```

Yes, subjects in control answer all the questions. There are 262 subjects in control.

```{r}
# check if subjects in treatment answer all questions
d %>%
  select(treatment_employment, treatment_education, treatment_retirement, treatment_cybersecurity) %>%
  summarise_all(funs(sum(!is.na(.))))
```

Yes, subjects in treatment answer all the questions. There are 295 subjects in treatment.

### Separate between treatment and control

```{r}
# filter for subjects in control
control <- d %>% filter(!is.na(control_employment) & 
                        !is.na(control_education) & 
                        !is.na(control_retirement) & 
                        !is.na(control_cybersecurity))
```

```{r}
# verify that control has 262 subjects
nrow(control) == 262
```

```{r}
# filter for subjects in treatment
treatment <- d %>% filter(!is.na(treatment_employment) & 
                          !is.na(treatment_education) & 
                          !is.na(treatment_retirement) & 
                          !is.na(treatment_cybersecurity))
```
```{r}
# verify that treatment has 295 subjects
nrow(treatment) == 295
```

### Explore the covariates

For most covariates, it might be sufficient to just show the histogram:
* gender
* age
*

#### 1. Gender

```{r}
# gender frequency in the entire study
(total.gender.freq <- d %>% 
  group_by(gender) %>% 
  summarize(freq = sum(n()))) 
```

```{r}
# percentage of noncompliant for the entire study
total.gender.freq[which(total.gender.freq == ""),]$freq / sum(total.gender.freq$freq) * 100
# percentage of female for the entire study
total.gender.freq[which(total.gender.freq == "Female"),]$freq / sum(total.gender.freq$freq) * 100
# percentage of male for the entire study
total.gender.freq[which(total.gender.freq == "Male"),]$freq / sum(total.gender.freq$freq) * 100
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the gender frequency in the entire study
total.gender.bp <- barplot(total.gender.freq$freq, names.arg=total.gender.freq$gender, ylim=c(0,300))
text(total.gender.bp, 0, round(total.gender.freq$freq, 1), cex=1, pos=3)
```

**TOTAL**
no answer: 1 (0.1795332%)
female: 282 (50.62837%)
male: 274 (49.1921%)

There is almost equal number of male and female in the entire study.

```{r}
# gender frequency in the control group
(control.gender.freq <- control %>% 
  group_by(gender) %>% 
  summarize(freq = sum(n()))) 
```

```{r}
# percentage of noncompliant in the control group
control.gender.freq[which(control.gender.freq == ""),]$freq / sum(control.gender.freq$freq) * 100
# percentage of female in the control group
control.gender.freq[which(control.gender.freq == "Female"),]$freq / sum(control.gender.freq$freq) * 100
# percentage of male in the control group
control.gender.freq[which(control.gender.freq == "Male"),]$freq / sum(control.gender.freq$freq) * 100
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the gender frequency in the control group
control.gender.bp <- barplot(control.gender.freq$freq, names.arg=control.gender.freq$gender, ylim=c(0,300))
text(control.gender.bp, 0, round(control.gender.freq$freq, 1), cex=1, pos=3)
```

**CONTROL**
no answer: 1 (0.3816794%)
female: 127 (48.47328%)
male: 134 (51.14504%)

There is slightly more male than female in the control group.

```{r}
# gender frequency in the treatment group
(treatment.gender.freq <- treatment %>% 
  group_by(gender) %>% 
  summarize(freq = sum(n()))) 
```

```{r}
# percentage of female in the treatment group
treatment.gender.freq[which(treatment.gender.freq == "Female"),]$freq / sum(treatment.gender.freq$freq) * 100
# percentage of male in the treatment group
treatment.gender.freq[which(treatment.gender.freq == "Male"),]$freq / sum(treatment.gender.freq$freq) * 100
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the gender frequency in the treatment group
treatment.gender.bp <- barplot(treatment.gender.freq$freq, names.arg=treatment.gender.freq$gender, ylim=c(0,300))
text(treatment.gender.bp, 0, round(treatment.gender.freq$freq, 1), cex=1, pos=3)
```

**TREATMENT**
female: 155 (52.54237%)
male: 140 (47.45763%)

There is slightly more female than male in the treatment group.

#### 2. Age

```{r}
# age frequency in the entire study
total.age.freq <- d %>% 
  group_by(age) %>% 
  summarize(freq = sum(n()))
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the age frequency in the entire study
total.age.bp <- barplot(total.age.freq$freq, names.arg=total.age.freq$age, ylim=c(0,250))
text(total.age.bp, 0, round(total.age.freq$freq, 1), cex=1, pos=3)
```

```{r}
# age frequency in the control group
control.age.freq <- control %>% 
  group_by(age) %>% 
  summarize(freq = sum(n())) 
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the age frequency in the control group
control.age.bp <- barplot(control.age.freq$freq, names.arg=control.age.freq$age, ylim=c(0,250))
text(control.age.bp, 0, round(control.age.freq$freq, 1), cex=1, pos=3)
```

```{r}
# age frequency in the treatment group
treatment.age.freq <- treatment %>% 
  group_by(age) %>% 
  summarize(freq = sum(n())) 
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the age frequency in the treatment group
treatment.age.bp <- barplot(treatment.age.freq$freq, names.arg=treatment.age.freq$age, ylim=c(0,250))
text(treatment.age.bp, 0, round(treatment.age.freq$freq, 1), cex=1, pos=3)
```

Age has a positively skewed distribution with subjects mostly in the age range of 25-34. The age distribution in the treatment and control group are approximately similar to each other.

#### 3. Highest education

```{r}
highest_education.order <- c("Less than high school", "High school graduate", "Some college", "2 year degree", "4 year degree", "Doctorate", "Professional degree")
```

```{r}
# highest_education frequency in the entire study
total.highest_education.freq <- d %>% 
  group_by(highest_education) %>% 
  summarize(freq = sum(n())) %>%
  left_join(data.frame(highest_education=highest_education.order), .)
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the highest_education frequency in the entire study
par(mar=c(10,3,1,1))
total.highest_education.bp <- barplot(total.highest_education.freq$freq, names.arg=total.highest_education.freq$highest_education, ylim=c(0,200), las=2)
text(total.highest_education.bp, 0, round(total.highest_education.freq$freq, 1), cex=1, pos=3)
```

```{r}
# highest_education frequency in the control group
control.highest_education.freq <- control %>% 
  group_by(highest_education) %>% 
  summarize(freq = sum(n())) %>%
  left_join(data.frame(highest_education=highest_education.order), .)
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the highest_education frequency in the control group
par(mar=c(10,3,1,1))
control.highest_education.bp <- barplot(control.highest_education.freq$freq, names.arg=control.highest_education.freq$highest_education, ylim=c(0,200), las=2)
text(control.highest_education.bp, 0, round(control.highest_education.freq$freq, 1), cex=1, pos=3)
```

```{r}
# highest_education frequency in the treatment group
treatment.highest_education.freq <- treatment %>% 
  group_by(highest_education) %>% 
  summarize(freq = sum(n())) %>%
  left_join(data.frame(highest_education=highest_education.order), .)
```

```{r out.width="49%", fig.align="center", fig.show="hold"}
# plot the highest_education frequency in the treatment group
par(mar=c(10,3,1,1))
treatment.highest_education.bp <- barplot(treatment.highest_education.freq$freq, names.arg=treatment.highest_education.freq$highest_education, ylim=c(0,200), las=2)
text(treatment.highest_education.bp, 0, round(treatment.highest_education.freq$freq, 1), cex=1, pos=3)
```

The majority of the survey takers have a 4 year degree, and the highest education level is approximately the same for treatment and control.

#### 4. Employment status



#### 5. Marital status

#### 6. Zip code

#### 7. Community

#### 8. Can vote

#### 9. Political party

#### 10. Ethnicity

#### 11. Income

#### 12. Have kids

#### 13. How often they access internet from their mobile phones

#### 14. How often they access internet from home

#### 15. How often they access internet from work

#### 16. Who pays the internet

#### 17. 


_First.Click, _Last.Click, _Page.Submit, _Click.Count

covariate:
_Click.Count
time = _Page.Submit - _First.Click


# TODO 2

calculate length of time page_submit - first_click
can use click.count as covariate
can use length of time as covariate



# TODO 3

1) a pre-analysis/EDA, just looking at some plots of scores for each answer, with a few cuts by covariates (e.g. histograms by political preference, gender; box-whisker plots for age groups, etc.)

# TODO 4

2) then, for each question, starting with our education placebo test, we have a _stargazer_ output that has 3 regressions: a) with only the treatment dummy, b) with treatment plus key covariates, and c) with treatment, key covariates AND interaction terms (i.e. HTEs)


## References

1. renaming column names: http://rprogramming.net/rename-columns-in-r/ 

## Unused stuff

### IP
Get state, country information from IPs. IPs are not reliable though. Plus, it's dang slow.

```
freegeoip <- function(ip, format = ifelse(length(ip)==1,'list','dataframe'))
{
    if (1 == length(ip))
    {
        # a single IP address
        url <- paste(c("http://api.ipstack.com/", ip, "?access_key=0e93a4defcd645bd8829ad75a7223437&output=json&legacy=1/"), collapse='')
        ret <- fromJSON(readLines(url, warn=FALSE))
        if (format == 'dataframe')
            ret <- data.frame(t(unlist(ret)))
        return(ret)
    } else {
        ret <- data.frame()
        for (i in 1:length(ip))
        {
            r <- freegeoip(ip[i], format="dataframe")
            ret <- bind_rows(ret, r)
        }
        return(ret)
    }
}   

try.ip <- function(ip) {
  suppressWarnings(try(freegeoip(ip), silent = TRUE))
}

ips <- try.ip(data$IPAddress)
```

### LatLong

Get state, country information from Google API. Unfortunately, it's taking too long and Google has a limit for the number of API calls.

How to call the API via the browser:
https://maps.googleapis.com/maps/api/geocode/json?latlng=40.714224,-73.961452&key=AIzaSyC8Q7FY6SzmEfpMTOcx2BTrnYaRkzX12Ik

How to call the API via R:
```
library(revgeo)
revgeo(longitude=-73.961452, latitude=40.714224, output="frame", provider="google", API="AIzaSyC8Q7FY6SzmEfpMTOcx2BTrnYaRkzX12Ik")
```

This will always fail because of the limitation to the number of API calls:
```
ll <- revgeo(longitude = data$LocationLongitude, latitude = data$LocationLatitude, output = "frame", provider = "google", API = "AIzaSyC8Q7FY6SzmEfpMTOcx2BTrnYaRkzX12Ik")
```

Getting USA (or any other country)'s latlong

```
library(ggmap)
geocode("USA")
```
